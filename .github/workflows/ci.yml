name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_REGISTRY: localhost

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      any-cuda: ${{ steps.filter.outputs['any-cuda'] }}
      any-python: ${{ steps.filter.outputs['any-python'] }}
      cuda-versions: ${{ steps.cuda-versions.outputs.versions }}
      python-versions: ${{ steps.python-versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch current + parent commit so paths-filter can diff on push events
          fetch-depth: 2

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            any-cuda:
              - 'cuda/**/Containerfile'
              - 'cuda/**/app.conf'
              - scripts/fix-permissions
              - requirements-build.txt
            any-python:
              - 'python/**/Containerfile'
              - 'python/**/app.conf'
              - scripts/fix-permissions
              - requirements-build.txt

      - name: Build CUDA version matrix
        id: cuda-versions
        if: steps.filter.outputs.any-cuda == 'true'
        run: |
          CHANGED_FILES='${{ steps.filter.outputs.any-cuda_files }}'
          
          # Check if common files changed (affects all versions)
          if echo "$CHANGED_FILES" | grep -qE 'requirements-build\.txt|scripts/fix-permissions'; then
            echo "Common files changed - including all CUDA versions"
            # Get all available CUDA versions from directory structure
            VERSIONS=$(find cuda -maxdepth 1 -type d -name '[0-9]*.[0-9]*' \
              | sed 's|cuda/||' \
              | sort -V \
              | awk 'BEGIN{printf "["} {printf "%s\"%s\"", (NR>1?",":""), $0} END{print "]"}')
          else
            # Extract only specific versions from changed cuda/<version>/{Containerfile,app.conf} paths
            VERSIONS=$(echo "$CHANGED_FILES" \
              | tr -d '[]" ' \
              | tr ',' '\n' \
              | awk -F/ '$1=="cuda" && $2 ~ /^[0-9]+\.[0-9]+$/ && ($3=="Containerfile" || $3=="app.conf") {print $2}' \
              | sort -uV \
              | awk 'BEGIN{printf "["} {printf "%s\"%s\"", (NR>1?",":""), $0} END{print "]"}')
          fi
          
          echo "versions=${VERSIONS}" >> "$GITHUB_OUTPUT"

      - name: Build Python version matrix
        id: python-versions
        if: steps.filter.outputs.any-python == 'true'
        run: |
          CHANGED_FILES='${{ steps.filter.outputs.any-python_files }}'
          
          # Check if common files changed (affects all versions)
          if echo "$CHANGED_FILES" | grep -qE 'requirements-build\.txt|scripts/fix-permissions'; then
            echo "Common files changed - including all Python versions"
            # Get all available Python versions from directory structure
            VERSIONS=$(find python -maxdepth 1 -type d -name '[0-9]*.[0-9]*' \
              | sed 's|python/||' \
              | sort -V \
              | awk 'BEGIN{printf "["} {printf "%s\"%s\"", (NR>1?",":""), $0} END{print "]"}')
          else
            # Extract only specific versions from changed python/<version>/{Containerfile,app.conf} paths
            VERSIONS=$(echo "$CHANGED_FILES" \
              | tr -d '[]" ' \
              | tr ',' '\n' \
              | awk -F/ '$1=="python" && $2 ~ /^[0-9]+\.[0-9]+$/ && ($3=="Containerfile" || $3=="app.conf") {print $2}' \
              | sort -uV \
              | awk 'BEGIN{printf "["} {printf "%s\"%s\"", (NR>1?",":""), $0} END{print "]"}')
          fi
          
          echo "versions=${VERSIONS}" >> "$GITHUB_OUTPUT"

  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[lint]"

      - name: Run ruff check
        run: ruff check tests/

      - name: Run ruff format check
        run: ruff format --check tests/

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[type]"

      - name: Run mypy
        run: mypy tests/

  detect-containerfile-changes:
    name: Detect Containerfile Changes
    runs-on: ubuntu-latest
    outputs:
      containerfiles_changed: ${{ steps.changed.outputs.any_changed }}
      containerfiles_list: ${{ steps.changed.outputs.all_changed_files }}
      containerfiles: ${{ steps.containerfiles-matrix.outputs.containerfiles }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed Containerfiles
        id: changed
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/Containerfile*
            **/Dockerfile*
          json: true

      - name: Create Lint Job Matrix
        id: containerfiles-matrix
        run: echo "containerfiles=${{ steps.changed.outputs.all_changed_files }}" >> "$GITHUB_OUTPUT"
        
  lint-containerfiles:
    name: Lint Containerfiles (Hadolint)
    runs-on: ubuntu-latest
    needs: detect-containerfile-changes
    if: needs.detect-containerfile-changes.outputs.containerfiles_changed == 'true'
    strategy:
      matrix:
        containerfile: ${{ fromJSON(needs.detect-containerfile-changes.outputs.containerfiles) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint changed Containerfiles
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: ${{ matrix.containerfile }}
          config: .hadolint.yaml

  test-python-image:
    name: Test Python ${{ matrix.version }} Image
    runs-on: ubuntu-latest
    needs: [lint, type-check, changes, lint-containerfiles]
    # Run when Python-related files change AND lint-containerfiles passed/skipped
    if: |
      always() &&
      needs.changes.outputs['any-python'] == 'true' &&
      needs.changes.outputs.python-versions != '' &&
      needs.changes.outputs.python-versions != '[]' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      (needs.lint-containerfiles.result == 'success' || needs.lint-containerfiles.result == 'skipped')
    strategy:
      matrix:
        version: ${{ fromJSON(needs.changes.outputs.python-versions || '[]') }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install -e ".[test]"

      - name: Get image tag from config
        id: config
        run: |
          TAG=$(grep '^IMAGE_TAG=' python/${{ matrix.version }}/app.conf | cut -d'=' -f2)
          if [ -z "$TAG" ]; then
            echo "::error::IMAGE_TAG not found in python/${{ matrix.version }}/app.conf"
            exit 1
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build Python ${{ matrix.version }} image
        run: ./scripts/build.sh python-${{ matrix.version }}

      - name: Run Python image tests
        env:
          PYTHON_IMAGE: ${{ env.IMAGE_REGISTRY }}/odh-midstream-python-base:${{ steps.config.outputs.tag }}
          PYTHON_VERSION: ${{ matrix.version }}
        run: pytest tests/test_python_image.py tests/test_common.py -v

  test-cuda-image:
    name: Test CUDA ${{ matrix.version }} Image
    runs-on: ubuntu-latest
    needs: [lint, type-check, changes, lint-containerfiles]
    # Run when CUDA-related files change AND lint-containerfiles passed/skipped
    if: |
      always() &&
      needs.changes.outputs['any-cuda'] == 'true' &&
      needs.changes.outputs.cuda-versions != '' &&
      needs.changes.outputs.cuda-versions != '[]' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      (needs.lint-containerfiles.result == 'success' || needs.lint-containerfiles.result == 'skipped')
    strategy:
      matrix:
        version: ${{ fromJSON(needs.changes.outputs.cuda-versions || '[]') }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      # Free disk space for CUDA build (~14GB image)
      # https://github.com/jlumbroso/free-disk-space
      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false  # Keep for actions/setup-python
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install -e ".[test]"

      - name: Get image tag from config
        id: config
        run: |
          TAG=$(grep '^IMAGE_TAG=' cuda/${{ matrix.version }}/app.conf | cut -d'=' -f2)
          if [ -z "$TAG" ]; then
            echo "::error::IMAGE_TAG not found in cuda/${{ matrix.version }}/app.conf"
            exit 1
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build CUDA ${{ matrix.version }} image
        run: ./scripts/build.sh cuda-${{ matrix.version }}

      - name: Run CUDA image tests
        env:
          CUDA_IMAGE: ${{ env.IMAGE_REGISTRY }}/odh-midstream-cuda-base:${{ steps.config.outputs.tag }}
          CUDA_VERSION: ${{ matrix.version }}
        run: pytest tests/test_cuda_image.py tests/test_common.py -v

  # Aggregator job for branch protection - use this as the required status check
  # This ensures all jobs (including conditional ones) must pass before merging
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint
      - type-check
      - lint-containerfiles
      - test-python-image
      - test-cuda-image
    steps:
      - name: Check CI status
        run: |
          echo "lint: ${{ needs.lint.result }}"
          echo "type-check: ${{ needs.type-check.result }}"
          echo "lint-containerfiles: ${{ needs.lint-containerfiles.result }}"
          echo "test-python-image: ${{ needs.test-python-image.result }}"
          echo "test-cuda-image: ${{ needs.test-cuda-image.result }}"

          # Fail if any required job failed or was cancelled
          # Note: 'skipped' is OK for conditional jobs (lint-containerfiles, test-cuda-image)
          if [[ "${{ needs.lint.result }}" == "failure" || \
                "${{ needs.lint.result }}" == "cancelled" || \
                "${{ needs.type-check.result }}" == "failure" || \
                "${{ needs.type-check.result }}" == "cancelled" || \
                "${{ needs.lint-containerfiles.result }}" == "failure" || \
                "${{ needs.lint-containerfiles.result }}" == "cancelled" || \
                "${{ needs.test-python-image.result }}" == "failure" || \
                "${{ needs.test-python-image.result }}" == "cancelled" || \
                "${{ needs.test-cuda-image.result }}" == "failure" || \
                "${{ needs.test-cuda-image.result }}" == "cancelled" ]]; then
            echo "::error::One or more CI jobs failed or were cancelled"
            exit 1
          fi

          echo "All CI checks passed!"
